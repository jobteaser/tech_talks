<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>Cockpit</title>

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="lib/reveal.js/css/reveal.min.css">
    <link rel="stylesheet" href="lib/reveal.js/css/theme/night.css">
    <link rel="stylesheet" href="lib/template.css">

    <!-- For syntax highlighting -->
    <link rel="stylesheet" href="lib/reveal.js/lib/css/zenburn.css">

    <!-- If the query includes 'print-pdf', include the PDF print sheet -->
    <script>
      if( window.location.search.match( /print-pdf/gi ) ) {
        var link = document.createElement( 'link' );
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = 'css/print/pdf.css';
        document.getElementsByTagName( 'head' )[0].appendChild( link );
      }
    </script>

    <!--[if lt IE 9]>
    <script src="lib/reveal.js/lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>

  <body>
    <div class="reveal">
      <div class="slides" id="content">
        <section data-markdown
                 data-separator="==="
                 data-vertical="---"><script type="text/template">

# Cockpit

## Patterns and guidelines

===

# Guidelines

===

## Slim Model

* Atomic domain object

* Persistence / querying (scopes)

* Mandatory validations

* Rich virtual attributes (Range, Enum, ...)

* No callbacks

===

## Dumb views

* NO sql

* No logic

* Helpers ONLY for HTML generation

===

## "Functional" services

* `::call` (well, `::call!` actually)

* For all business logic

* Rule of thumb : do I still need it if the app is CLI-only ?

* `subject { described_class.call(arguments) }`

===

## Presenters

* View widgets

* Collection decoration

* `subject { described_class.present(arguments) }`

===

## Form objects

* Params sanitization

* Business validations

* Prepopulation

===

## Slim controller

```ruby
# app/controllers/admin/dashboards_controller.rb
def show
  @view = CompanyDashboardPresenter.present(
    current_user: current_user,
    company: current_user.company
  )
end
```

---

```ruby
# app/controllers/directory/formations_controller.rb
def index
  # Handle criteria
  search_form = FormationSearchForm.new(current_user, params[:filters])

  # Perform the search
  scope = SearchFormations.call!(
    current_user: current_user,
    filters: search_form.attributes
  )

  # Display the results
  @view = FormationSearchResults.present(
    current_user: current_user,
    scope: scope,
    search_form: search_form,
    page: params[:page]
  )
end
```

---

```ruby
# app/controllers/admin/actions_controller.rb
def update
  @action_form = ActionForm.new(current_user, action, params[:admin_action_form])

  # Validations
  render(:edit) && return unless @action_form.valid?

  # Actual update
  UpdateAction.call!(
    current_user: current_user,
    action: action,
    attributes: @action_form.attributes
  )

  # Response
  flash[:success] = t('.success')
  redirect_to admin_action_path(action)
end
```

===

## Local gems

* Instead of `/lib`

```ruby
# Gemfile
gem 'active_record_or_scope', path: './gems/active_record_or_scope'
```

===

## Namespacing

* Routes

* Controllers / Mailers

* Presenters / Serializers

* Views

===

## Assets

* Drop sprockets

* ES6

* `gulp watch`

===

## No file handling

* Cloudinary for images

* S3 for other files

* Persist URLs or IDs only

===

## Configuration

Via unversioned .env

```sh
# http://ddollar.github.com/foreman/
ASSET_HOST=http://localhost:3000
HOST=http://localhost:3000
PORT=3000
RACK_ENV=development
SECRET_KEY_BASE=development_secret
REDIS_URL=redis://redis-master:6379/12
S3_BUCKET=jt-cockpit-development
AWS_ACCESS_KEY_ID=79efd76b0653040b881e24a33f9fe0c1
AWS_SECRET_ACCESS_KEY=79efd76b0653040b881e24a33f9fe0c1
SIDEKIQ_CONCURRENCY=1
SMTP_ADDRESS=mailtrap.io
SMTP_HOST=mailtrap.io
SMTP_PASSWORD=79efd76b0653040b881e24a33f9fe0c1
SMTP_PORT=2525
SMTP_USERNAME=79efd76b0653040b881e24a33f9fe0c1
SEARCHBOX_SSL_URL=es-master:9200
DATABASE_URL=postgresql://postgres@pg-master/cockpit_development
LOCALEAPP_API_KEY=79efd76b0653040b881e24a33f9fe0c1
```

===

# Patterns

===

## Search service

---

```ruby
SearchActions.call!(
  current_user: current_user, {
    school: school,
    status: :pending
    # [...]
  }
)
```

---

```ruby
# app/services/search_actions.rb
class SearchActions

  include Service

  def call(current_user:, filters: {})
    filters.reduce(base_scope(current_user)) do |scope, (key, value)|
      send :"filter_by_#{key}", scope, value
    end
  end

  private

  def base_scope(current_user)
    Action.for_company(current_user.company)
  end

  # Filtering logic
  def filter_by_action_kind(scope, action_kind)
    return scope unless action_kind
    scope.where(action_kind: action_kind)
  end

  def filter_by_school(scope, school)
    return scope unless school
    scope.for_schools([school])
  end

end
```

---

* Avoid long-ass methods

* Nice for isolation testing

===

## Eager loading at the presenter level

---

```ruby
@formations = FormationPresenter.present(scope)
```

```ruby
module Directory
  # Presenter for school record
  class FormationPresenter

    INCLUDES = [:professor, { school: [:reports, { school_profile: :default_contact }] }].freeze

    def self.present(current_user, scope)
      scope.includes(*INCLUDES).map do |item|
        new(current_user: current_user, formation: item)
      end
    end

    def initialize(current_user:, formation:)
    end
  end
end
```

===

## Simple form inputs

---

```
pry > action.date
=> 2016-08-02..2016-08-05
```

```slim
-# app/views/admin/actions/_form.html.slim
= f.input :date, as: :date_range_picker, label: t('.date')
```

---

```ruby
# app/presenters/custom_inputs/date_range_picker_input.rb
require 'simple_form_input_helpers'

module CustomInputs
  # Custom input for a date range calendar picker
  class DateRangePickerInput < SimpleForm::Inputs::StringInput

    include SimpleFormInputHelpers

    def input(_wrapper_options)
      range = value || (Date.today..Date.today)

      template.content_tag(
        'date-range-picker',
        nil,
        name: input_name,
        begin: range.begin.to_s(:iso8601),
        end: range.end.to_s(:iso8601)
      )
    end

  end
end
```

---

<pre>
<code class="javascript">
// app/assets/components/date_range_picker.js
/* globals $, Vue, moment, Rails */
export default Vue.component('date-range-picker', {

  template: `
    <div class="input-group">
      <input type="hidden" name="{{name}}[begin]" v-bind:value="begin.format('YYYY-MM-DD')">
      <input type="hidden" name="{{name}}[end]" v-bind:value="end.format('YYYY-MM-DD')">
      <input class="form-control" ref="picker">
      <span class="input-group-addon"><i class="icon-calendar22"></i></span>
    </div>
  `,
  props: {
    name: String,
    begin: {
      coerce: (date) => moment(date, 'YYYY-MM-DD'),
    },
    end: {
      coerce: (date) => moment(date, 'YYYY-MM-DD'),
    },
  },
  ready() {
    const $picker = $(this.$el).find('[ref="picker"]');
    $picker.daterangepicker({
      startDate: this.begin,
      endDate: this.end,
      showDropdowns: true,
      minDate: moment('20100101', 'YYYYMMDD'),
      locale: Rails.I18n.daterange_picker,
    });

    $picker.on('hide.daterangepicker', this.onBlur);
  },
  methods: {
    onBlur(_event, picker) {
      this.begin = picker.startDate;
      this.end = picker.endDate;
    },
  },
});
</code>
</pre>

---

```
pry > params[:date]
=> { begin: '2016-08-03', end: '2016-09-01' }
```

```
# app/presenters/admin/action_form.rb
def parse_date(date_params)
  self.date = (Date.parse(date_params[:begin])..Date.parse(date_params[:end]))
end
```

```
pry > @action_form.date
=> 2016-08-03..2016-09-01
```

===

# Goodies

===

## Bundler audit

[rubysec/bundler-audit](https://github.com/rubysec/bundler-audit)

---

```ruby
# Gemfile
group :development, :test do
  gem 'bundler-audit', require: false
end

# Rakefile
task default: "bundle:audit"
```

---

![screenshot](cockpit/bundler_audit.png)

===

## Seeds

---

```ruby
# db/seeds.rb

# [...]

3.times do
  FactoryGirl.create(
    :action_over,
    :with_debriefer,
    action_kind: action_kinds.sample,
    company: company
  )
end
```

---

* Review app seeding

* Migration testing

* Help define clean factories

===

## Premailer

[premailer/premailer](https://github.com/premailer/premailer)
[fphilipe/premailer-rails](https://github.com/fphilipe/premailer-rails)

---

```html
<!-- app/views/layout/mailer.html.erb -->
<html>
<head>
  <style>
  * {
    font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif;
    font-size: 100%;
    line-height: 1.6em;
    margin: 0;
    padding: 0;
  }

  img {
    max-width: 600px;
    width: 100%;
  }
  </style>
</head>
<body>
  <%= yield %>
</body>
</html>
```

---

![mail](cockpit/mail.png)

===

# Coming soon-ish

---

* Rails 5

* Policies

* Webpack for vue components

* Drop ActiveRecord ?

        </script></section>

      </div>

    </div>

    <script src="lib/reveal.js/lib/js/head.min.js"></script>
    <script src="lib/reveal.js/js/reveal.min.js"></script>
    <script src="lib/jquery/dist/jquery.min.js"></script>
    <script src="config.js"></script>

  </body>
</html>
